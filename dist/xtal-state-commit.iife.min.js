!function(){const t="disabled";const e="history-state-update";function s(t,e){let s=t.querySelector("iframe[xtal-state]");return null===s?((s=document.createElement("iframe")).setAttribute("xtal-state",""),s.addEventListener("load",()=>{s.setAttribute("loaded",""),null!==e&&e(s)}),s.src="blank.html",s.style.display="none",t.appendChild(s)):s.hasAttribute("loaded")?null!==e&&e(s):s.addEventListener("load",()=>{null!==e&&e(s)}),s.contentWindow}function r(t,s){const r={oldState:t,newState:s.history.state},i=new CustomEvent(e,{detail:r,bubbles:!0,composed:!0});s.dispatchEvent(i)}function i(t){if(t.__xtalStateInit)return;t.__xtalStateInit=!0;const e=t.history.pushState.bind(t.history);t.history.pushState=function(s,i,n){const a=t.history.state;e(s,i,n),r(a,t)};const s=t.history.replaceState.bind(t.history);t.history.replaceState=function(e,i,n){const a=t.history.state;s(e,i,n),r(a,t)}}const n="level";class a extends(function(e){return class extends e{constructor(){super(...arguments),this._evCount={}}static get observedAttributes(){return[t]}get disabled(){return this._disabled}set disabled(e){this.attr(t,e,"")}attr(t,e,s){this[(e?"set":"remove")+"Attribute"](t,s||e)}to$(t){const e=t%2;return(t-e)/2+"-"+e}incAttr(t){const e=this._evCount;t in e?e[t]++:e[t]=0,this.attr("data-"+t,this.to$(e[t]))}attributeChangedCallback(e,s,r){switch(e){case t:this._disabled=null!==r}}de(t,e,s=!1){const r=t+(s?"":"-changed"),i=new CustomEvent(r,{detail:e,bubbles:!0,composed:!1});return this.dispatchEvent(i),this.incAttr(r),i}_upgradeProperties(t){t.forEach(t=>{if(this.hasOwnProperty(t)){let e=this[t];delete this[t],this[t]=e}})}}}(HTMLElement)){constructor(){super(...arguments),this._level="global"}get level(){return this._level}set level(t){this.attr(n,t)}static get observedAttributes(){return super.observedAttributes.concat([n])}get window(){return this._window}attributeChangedCallback(t,e,s){switch(super.attributeChangedCallback(t,e,s),t){case n:this._level=s}this.onPropsChange()}connectedCallback(){this.style.display="none",this._upgradeProperties(["disabled",n]),this._conn=!0,this.onPropsChange()}onPropsChange(){return!(this._conn&&!this._disabled)||(this._window||(this._notReady=!0,(t=this,e=this._level,new Promise((r,n)=>{switch(e){case"global":i(self),r(self);break;case"local":s(t.parentElement,t=>{i(t.contentWindow),r(t.contentWindow)});break;case"shadow":s(function(t){const e=function(t){let e=t;for(;e=e.parentNode;){if(11===e.nodeType)return e.host;if("BODY"===e.tagName)return null}return null}(t);return null===e.shadowRoot?e:e.shadowRoot}(t),t=>{i(t.contentWindow),r(t.contentWindow)});break;default:s(function(t,e){let s=t.parentElement;for(;s;){if(s.matches(e))return s;s=s.parentElement}}(t,e),t=>{i(t.contentWindow),r(t.contentWindow)})}})).then(t=>{this._window=t,this._notReady=!1})),!!this._notReady||void 0);var t,e}}const l=(t,e)=>{let s;return function(){clearTimeout(s),s=setTimeout(()=>t.apply(this,arguments),e)}};const h="with-path";function o(t){return class extends t{get withPath(){return this._withPath}set withPath(t){this.setAttribute(h,t)}wrap(t){if(this._withPath){let e={};return function(t,e,s,r){const i=e.shift(),n=t[i],a={[i]:n||{}};let l=a[i];const h=e.pop();if(e.forEach(t=>{let e=l[t];e||(e=l[t]={}),l=e}),l[h]&&"object"==typeof s?Object.assign(l[h],s):void 0===h?a[i]=s:l[h]=s,r)try{Object.assign(t,a)}catch(t){}}(e,this._withPath.split("."),t,!0),e}return t}}}const c="url",u="url-search",d="replace-url-value";const b="make",p="rewrite",_="history",w="title",g="new";!function(t){let e=t.is;customElements.get(e)?console.warn("Already registered "+e):customElements.define(e,t)}(class extends(function(t){return class extends t{get url(){return this._url}set url(t){this.attr(c,t)}get urlSearch(){return this._urlSearch}set urlSearch(t){this.attr(u,t)}get replaceUrlValue(){return this._replaceUrlValue}set replaceUrlValue(t){this.attr(d,t)}get stringifyFn(){return this._stringifyFn}set stringifyFn(t){this._stringifyFn=t}static get UFAttribs(){return[c,u,d]}attributeChangedCallback(t,e,s){switch(t){case c:this["_"+t]=s;break;case u:this._urlSearch=s;break;case d:this._replaceUrlValue=s}super.attributeChangedCallback&&super.attributeChangedCallback(t,e,s)}connectedCallback(){this._upgradeProperties([c,"urlSearch","replaceUrlValue","stringifyFn"]),super.connectedCallback&&super.connectedCallback()}adjustUrl(t){if(this._stringifyFn)t=this._stringifyFn(this);else if(this._replaceUrlValue&&this._urlSearch){const e=new RegExp(this._urlSearch);t=t.replace(e,this._replaceUrlValue)}return t}}}(o(a))){constructor(){super(...arguments),this._title=""}static get is(){return"xtal-state-commit"}get make(){return this._make}set make(t){this.attr(b,t,"")}get rewrite(){return this._rewrite}set rewrite(t){this.attr(p,t,"")}get history(){return this._window.history.state}set history(t){this._history=t,this.onPropsChange()}get title(){return this._title}set title(t){this.attr(w,t)}get new(){return this._new}set new(t){this.attr(g,t,"")}static get observedAttributes(){return super.observedAttributes.concat(super.UFAttribs).concat([b,p,w,h,g])}attributeChangedCallback(t,e,s){switch(t){case g:case p:case b:this["_"+t]=null!==s;break;case w:this["_"+t]=s;break;case h:this._withPath=s}super.attributeChangedCallback(t,e,s)}connectedCallback(){this._upgradeProperties([b,p,w,"withPath","stringifyFn",g,"syncHistory"].concat([_])),this._debouncer=l(()=>{this.updateHistory()},50),super.connectedCallback()}onPropsChange(){if(!this._disabled)return super.onPropsChange()?!this._notReady||void setTimeout(()=>{this.onPropsChange()},50):!this._make&&!this._rewrite||void this._debouncer()}mergedHistory(){if(void 0!==this._history)return this.wrap(this._history)}updateHistory(){const t=this._new?{}:this.mergedHistory();if(null==t)return;const e=this.make?"push":"replace";if(this.value=t,this._disabled=!0,this.de("history",{value:t}),this._disabled=!1,this.make&&!this.url)return;let s=this._url;if(s&&!this._new||this._replaceUrlValue&&!this._new||(s=this._window.location.href),!s)return null;null!==(s=this.adjustUrl(s))&&this._window.history[e+"State"](t,this._title,s)}})}();