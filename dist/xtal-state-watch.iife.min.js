!function(){const t="disabled";const e="history-state-update";function s(t,e){let s=t.querySelector("iframe[xtal-state]");return null===s?((s=document.createElement("iframe")).setAttribute("xtal-state",""),s.addEventListener("load",()=>{s.setAttribute("loaded",""),null!==e&&e(s)}),s.src="blank.html",s.style.display="none",t.appendChild(s)):s.hasAttribute("loaded")?null!==e&&e(s):s.addEventListener("load",()=>{null!==e&&e(s)}),s.contentWindow}function i(t,s){const i={oldState:t,newState:s.history.state},n=new CustomEvent(e,{detail:i,bubbles:!0,composed:!0});s.dispatchEvent(n)}function n(t){if(t.__xtalStateInit)return;t.__xtalStateInit=!0;const e=t.history.pushState.bind(t.history);t.history.pushState=function(s,n,a){const o=t.history.state;e(s,n,a),i(o,t)};const s=t.history.replaceState.bind(t.history);t.history.replaceState=function(e,n,a){const o=t.history.state;s(e,n,a),i(o,t)}}const a="level";class o extends(function(e){return class extends e{constructor(){super(...arguments),this._evCount={}}static get observedAttributes(){return[t]}get disabled(){return this._disabled}set disabled(e){this.attr(t,e,"")}attr(t,e,s){this[(e?"set":"remove")+"Attribute"](t,s||e)}to$(t){const e=t%2;return(t-e)/2+"-"+e}incAttr(t){const e=this._evCount;t in e?e[t]++:e[t]=0,this.attr("data-"+t,this.to$(e[t]))}attributeChangedCallback(e,s,i){switch(e){case t:this._disabled=null!==i}}de(t,e,s=!1){const i=t+(s?"":"-changed"),n=new CustomEvent(i,{detail:e,bubbles:!0,composed:!1});return this.dispatchEvent(n),this.incAttr(i),n}_upgradeProperties(t){t.forEach(t=>{if(this.hasOwnProperty(t)){let e=this[t];delete this[t],this[t]=e}})}}}(HTMLElement)){constructor(){super(...arguments),this._level="global"}get level(){return this._level}set level(t){this.attr(a,t)}static get observedAttributes(){return super.observedAttributes.concat([a])}get window(){return this._window}attributeChangedCallback(t,e,s){switch(super.attributeChangedCallback(t,e,s),t){case a:this._level=s}this.onPropsChange()}connectedCallback(){this.style.display="none",this._upgradeProperties(["disabled",a]),this._conn=!0,this.onPropsChange()}onPropsChange(){return!(this._conn&&!this._disabled)||(this._window||(this._notReady=!0,(t=this,e=this._level,new Promise((i,a)=>{switch(e){case"global":n(self),i(self);break;case"local":s(t.parentElement,t=>{n(t.contentWindow),i(t.contentWindow)});break;case"shadow":s(function(t){const e=function(t){let e=t;for(;e=e.parentNode;){if(11===e.nodeType)return e.host;if("BODY"===e.tagName)return null}return null}(t);return null===e.shadowRoot?e:e.shadowRoot}(t),t=>{n(t.contentWindow),i(t.contentWindow)});break;default:s(function(t,e){let s=t.parentElement;for(;s;){if(s.matches(e))return s;s=s.parentElement}}(t,e),t=>{n(t.contentWindow),i(t.contentWindow)})}})).then(t=>{this._window=t,this._notReady=!1})),!!this._notReady||void 0);var t,e}}const r="watch",h="all",d="popstate";!function(t){let e=t.is;customElements.get(e)?console.warn("Already registered "+e):customElements.define(e,t)}(class extends o{static get is(){return"xtal-state-watch"}static get observedAttributes(){return super.observedAttributes.concat([r])}attributeChangedCallback(t,e,s){switch(super.attributeChangedCallback(t,e,s),t){case r:this._watch=""===s?h:d}this.notify()}pushReplaceHandler(t){const e=this._window;t.detail.newState&&e.__xtalStateInfo.startedAsNull&&!e.__xtalStateInfo.hasStarted?(e.__xtalStateInfo.hasStarted,this.dataset.historyInit="true",this.dataset.popstate="true"):(delete this.dataset.popstate,delete this.dataset.historyInit),this.history=this._window.history.state}popStateHandler(t){this.dataset.popstate="true",this.history=this._window.history.state}addSubscribers(){if(this._notReady)return void setTimeout(()=>{this.addSubscribers()},50);const t=this._window;switch(t.__xtalStateInfo||(t.__xtalStateInfo={startedAsNull:null===t.history.state}),this._watch){case h:case d:this._boundPushReplaceListener||(this._boundPushReplaceListener=this.pushReplaceHandler.bind(this),this._window.addEventListener(e,this._boundPushReplaceListener))}switch(this._watch){case d:this._boundPopStateListener||(this._boundPopStateListener=this.popStateHandler.bind(this),this._window.addEventListener(d,this._boundPopStateListener))}this._connected=!0,this.history=this._window.history.state}connectedCallback(){this._upgradeProperties([r]),super.connectedCallback(),this.addSubscribers()}disconnect(){this._boundPopStateListener&&this.removeEventListener(d,this._boundPopStateListener),this._boundPushReplaceListener&&this.removeEventListener(e,this._boundPushReplaceListener)}disconnectedCallback(){this.disconnect()}get history(){return this._history}set history(t){this._history=t,this._watch&&this.notify()}get watch(){return this._watch}set watch(t){this.attr(r,t)}notify(){this._watch&&!this._disabled&&this._connected&&void 0!==this._history&&null!==this._history&&this.de("history",{value:this._history})}})}();