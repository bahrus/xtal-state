!function(){function t(t){let e=t.is;customElements.get(e)?console.warn("Already registered "+e):customElements.define(e,t)}const e="disabled";const s="history-state-update";function i(t,e){let s=t.querySelector("iframe[xtal-state]");return null===s?((s=document.createElement("iframe")).setAttribute("xtal-state",""),s.addEventListener("load",()=>{s.setAttribute("loaded",""),null!==e&&e(s)}),s.src="blank.html",s.style.display="none",t.appendChild(s)):s.hasAttribute("loaded")?null!==e&&e(s):s.addEventListener("load",()=>{null!==e&&e(s)}),s.contentWindow}function r(t,e){const i={oldState:t,newState:e.history.state,initVal:!1},r=e.__xtalStateInfo;r.hasStarted||(r.hasStarted=!0,r.startedAsNull&&(i.initVal=!0));const n=new CustomEvent(s,{detail:i,bubbles:!0,composed:!0});e.dispatchEvent(n)}function n(t){if(t.__xtalStateInit)return;t.__xtalStateInit=!0,t.__xtalStateInfo||(t.__xtalStateInfo={startedAsNull:null===t.history.state});const e=t.history.pushState.bind(t.history);t.history.pushState=function(s,i,n){const a=t.history.state;e(s,i,n),r(a,t)};const s=t.history.replaceState.bind(t.history);t.history.replaceState=function(e,i,n){const a=t.history.state;s(e,i,n),r(a,t)}}const a="level";class o extends(function(t){return class extends t{constructor(){super(...arguments),this._evCount={}}static get observedAttributes(){return[e]}get disabled(){return this._disabled}set disabled(t){this.attr(e,t,"")}attr(t,e,s){this[(e?"set":"remove")+"Attribute"](t,s||e)}to$(t){const e=t%2;return(t-e)/2+"-"+e}incAttr(t){const e=this._evCount;t in e?e[t]++:e[t]=0,this.attr("data-"+t,this.to$(e[t]))}attributeChangedCallback(t,s,i){switch(t){case e:this._disabled=null!==i}}de(t,e,s=!1){const i=t+(s?"":"-changed"),r=new CustomEvent(i,{detail:e,bubbles:!0,composed:!1});return this.dispatchEvent(r),this.incAttr(i),r}_upgradeProperties(t){t.forEach(t=>{if(this.hasOwnProperty(t)){let e=this[t];delete this[t],this[t]=e}})}}}(HTMLElement)){constructor(){super(...arguments),this._level="global"}get level(){return this._level}set level(t){this.attr(a,t)}static get observedAttributes(){return super.observedAttributes.concat([a])}get window(){return this._window}attributeChangedCallback(t,e,s){switch(super.attributeChangedCallback(t,e,s),t){case a:this._level=s}this.onPropsChange()}connectedCallback(){this.style.display="none",this._upgradeProperties(["disabled",a]),this._conn=!0,this.onPropsChange()}onPropsChange(){return!(this._conn&&!this._disabled)||(this._window||(this._notReady=!0,(t=this,e=this._level,new Promise((s,r)=>{switch(e){case"global":n(self),s(self);break;case"local":i(t.parentElement,t=>{n(t.contentWindow),s(t.contentWindow)});break;case"shadow":i(function(t){const e=function(t){let e=t;for(;e=e.parentNode;){if(11===e.nodeType)return e.host;if(e.tagName.indexOf("-")>-1)return e;if("BODY"===e.tagName)return null}return null}(t);return null===e.shadowRoot?e:e.shadowRoot}(t),t=>{n(t.contentWindow),s(t.contentWindow)});break;default:i(function(t,e){let s=t.parentElement;for(;s;){if(s.matches(e))return s;s=s.parentElement}}(t,e),t=>{n(t.contentWindow),s(t.contentWindow)})}})).then(t=>{this._window=t,this._notReady=!1})),!!this._notReady||void 0);var t,e}}const l=(t,e)=>{let s;return function(){clearTimeout(s),s=setTimeout(()=>t.apply(this,arguments),e)}};const h="with-path";function c(t){return class extends t{get withPath(){return this._withPath}set withPath(t){this.setAttribute(h,t)}wrap(t){if(this._withPath){let e={};return function(t,e,s,i){const r=e.shift(),n=t[r],a={[r]:n||{}};let o=a[r];const l=e.pop();if(e.forEach(t=>{let e=o[t];e||(e=o[t]={}),o=e}),o[l]&&"object"==typeof s?Object.assign(o[l],s):void 0===l?a[r]=s:o[l]=s,i)try{Object.assign(t,a)}catch(t){}}(e,this._withPath.split("."),t,!0),e}return t}}}const u="url",d="url-search",b="replace-url-value";const p="make",_="rewrite",f="history",w="title",g="new";class y extends(function(t){return class extends t{get url(){return this._url}set url(t){this.attr(u,t)}get urlSearch(){return this._urlSearch}set urlSearch(t){this.attr(d,t)}get replaceUrlValue(){return this._replaceUrlValue}set replaceUrlValue(t){this.attr(b,t)}get stringifyFn(){return this._stringifyFn}set stringifyFn(t){this._stringifyFn=t}static get UFAttribs(){return[u,d,b]}attributeChangedCallback(t,e,s){switch(t){case u:this["_"+t]=s;break;case d:this._urlSearch=s;break;case b:this._replaceUrlValue=s}super.attributeChangedCallback&&super.attributeChangedCallback(t,e,s)}connectedCallback(){this._upgradeProperties([u,"urlSearch","replaceUrlValue","stringifyFn"]),super.connectedCallback&&super.connectedCallback()}adjustUrl(t){if(this._stringifyFn)t=this._stringifyFn(this);else if(this._replaceUrlValue&&this._urlSearch){const e=new RegExp(this._urlSearch);t=t.replace(e,this._replaceUrlValue)}return t}}}(c(o))){constructor(){super(...arguments),this._title=""}static get is(){return"xtal-state-commit"}get make(){return this._make}set make(t){this.attr(p,t,"")}get rewrite(){return this._rewrite}set rewrite(t){this.attr(_,t,"")}get history(){return this._window.history.state}set history(t){this._history=t,this.onPropsChange()}get title(){return this._title}set title(t){this.attr(w,t)}get new(){return this._new}set new(t){this.attr(g,t,"")}static get observedAttributes(){return super.observedAttributes.concat(super.UFAttribs).concat([p,_,w,h,g])}attributeChangedCallback(t,e,s){switch(t){case g:case _:case p:this["_"+t]=null!==s;break;case w:this["_"+t]=s;break;case h:this._withPath=s}super.attributeChangedCallback(t,e,s)}connectedCallback(){this._upgradeProperties([p,_,w,"withPath","stringifyFn",g,"syncHistory"].concat([f])),this._debouncer=l(()=>{this.updateHistory()},50),super.connectedCallback()}onPropsChange(){if(!this._disabled)return super.onPropsChange()?!this._notReady||void setTimeout(()=>{this.onPropsChange()},50):!this._make&&!this._rewrite||void this._debouncer()}mergedHistory(){if(void 0!==this._history)return this.wrap(this._history)}updateHistory(){const t=this._new?{}:this.mergedHistory();if(null==t)return;const e=this.make?"push":"replace";if(this.value=t,this._disabled=!0,this.de("history",{value:t}),this._disabled=!1,this.make&&!this.url)return;let s=this._url;if(s&&!this._new||this._replaceUrlValue&&!this._new||(s=this._window.location.href),!s)return null;null!==(s=this.adjustUrl(s))&&this._window.history[e+"State"](t,this._title,s)}}t(y);t(class extends y{static get is(){return"xtal-state-update"}mergedHistory(){const t=super.mergedHistory();if(void 0!==t)return null===this._window.history.state?t:function t(e,s){if("object"==typeof e&&"object"==typeof s){for(const i in s){const r=s[i],n=e[i];if(r)if(n)switch(typeof r){case"object":switch(typeof n){case"object":t(n,r);break;default:e[i]=r}break;default:e[i]=r}else e[i]=r}return e}}(Object.assign({},this._window.history.state),this.wrap(this._history))}})}();